<!DOCTYPE html>
<html lang="en">

<head>
    <title>Ports & Swords</title>
</head>

<body>
    <div id="app">
        <!-- TODO: move html to a separate html and load using jquery -->
        <canvas id="ctx" width="800" height="800" style="border:1px solid #000000;"></canvas>
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

        <!-- TODO: move code to separate js file js/handleClient.js -->
        <script>
            // define images
            var Img = {};
            Img.anchor = new Image();
            Img.anchor.src = '/client/img/anchor.png';
            Img.ram = new Image();
            Img.ram.src = '/client/img/ram.png';

            // define context
            var ctx = document.getElementById("ctx").getContext("2d");
            ctx.font = '30px Arial';

            // connect to the server
            var client = io();

            // listen for data
            client.on('package', function (data) {
                // clear screen
                ctx.clearRect(0, 0, 800, 800);

                // draw grid
                for (var i = 0; i < 16; i++) {
                    for (var j = 0; j < 16; j++) {
                        ctx.strokeRect(i * 50, j * 50, (i + 1) * 50, (j + 1) * 50);
                    }
                }

                // draw anchors
                [[650, 0], [700, 0], [750, 0], [750, 50], [750, 100], [0, 650], [0, 700], [0, 750], [50, 750], [100, 750]].forEach(element => {
                    var width = 50;
                    var height = 50;

                    ctx.drawImage(Img.anchor, 0, 0, Img.anchor.width, Img.anchor.height, element[0], element[1], width, height);
                });

                // draw players
                ctx.fillStyle = "#000000";
                for (var i = 0; i < data[0].length; i++) {
                    ctx.fillText(data[0][i].number, data[0][i].posX, data[i][0].posY);
                };

                // draw ships
                ctx.fillStyle = "#666666";
                for (var i = 0; i < data[1].length; i++) {
                    var ship = data[1][i];
                    ctx.fillRect(ship.posX, ship.posY, ship.width, ship.height);

                    var width = 50;
                    var height = 50;
                    ctx.drawImage(Img.ram, -10, -10, (Img.ram.width + 20), (Img.ram.height + 20), (ship.posX + ship.headingOffsetX), (ship.posY + ship.headingOffsetY), width, height);
                };
            });

            // emit input onkeydown
            document.onkeydown = function (event) {
                if (event.keyCode === 68) {
                    client.emit('keyPress', { inputId: 'right', state: true });
                } else if (event.keyCode === 83) {
                    client.emit('keyPress', { inputId: 'down', state: true });
                } else if (event.keyCode === 65) {
                    client.emit('keyPress', { inputId: 'left', state: true });
                } else if (event.keyCode === 87) {
                    client.emit('keyPress', { inputId: 'up', state: true });
                };
            };

            // emit input onkeyup
            document.onkeyup = function (event) {
                if (event.keyCode === 68) {
                    client.emit('keyPress', { inputId: 'right', state: false });
                } else if (event.keyCode === 83) {
                    client.emit('keyPress', { inputId: 'down', state: false });
                } else if (event.keyCode === 65) {
                    client.emit('keyPress', { inputId: 'left', state: false });
                } else if (event.keyCode === 87) {
                    client.emit('keyPress', { inputId: 'up', state: false });
                };
            };
        </script>
    </div>
</body>

</html>